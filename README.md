# Распределенный Cron с использованием Laravel

Этот проект реализует распределенный Cron с использованием Laravel, который позволяет выполнять задачи по расписанию на нескольких серверах.

## Описание работы приложения

Приложение использует Laravel для управления задачами, которые должны выполняться по расписанию. Задачи хранятся в базе данных и имеют статус, который указывает, выполняются ли они в данный момент.

### Распределение работы Cron

1. **Планирование задач**: Задачи планируются с использованием cron-выражений и хранятся в базе данных. Каждая задача имеет статус, который может быть `pending`, `running`, `completed` или `failed`.

2. **Выполнение задач**: Каждый сервер периодически проверяет базу данных на наличие задач со статусом `pending`, которые должны быть выполнены в текущий момент времени. Если такие задачи найдены, сервер пытается изменить их статус на `running`.

3. **Избежание конфликтов**: Чтобы избежать ситуации, когда несколько серверов одновременно берут одну и ту же задачу на выполнение, используется механизм блокировок. Только один сервер может успешно изменить статус задачи на `running`.

4. **Завершение выполнения**: После выполнения задачи её статус изменяется на `completed`. Если задача является одноразовой, она остается в статусе `completed`. В противном случае, её статус сбрасывается на `pending` для повторного выполнения в будущем.

## Стек технологий

- **Laravel**: Фреймворк для создания веб-приложений на PHP.
- **MySQL**: Система управления базами данных для хранения информации о задачах.
- **Docker**: Контейнеризация приложения для обеспечения консистентности среды.
- **Supervisor**: Система управления процессами для запуска и мониторинга cron.
- **Composer**: Менеджер зависимостей для PHP.

## Файлы проекта

- **Dockerfile**: Конфигурация Docker для сборки образа приложения.
- **docker-compose.yml**: Конфигурация Docker Compose для запуска контейнеров.
- **supervisord.conf**: Конфигурация Supervisor для управления процессами.
- **setup-cron.sh**: Скрипт для настройки crontab внутри контейнера.
- **ExecuteTask.php**: Команда Artisan для выполнения задач по расписанию.
- **Task.php**: Модель Laravel для управления задачами.
- **Log.php**: Модель Laravel для логирования выполнения задач.
- **.env.example**: Пример файла окружения для настройки переменных среды.
- **README.md**: Документация по проекту и инструкции по запуску.


## Как запустить проект

Чтобы запустить проект на локальной машине, выполните следующие шаги:

1. **Клонируйте репозиторий**:

   ```bash
   git clone git@github.com:SafeSoft-tlt/crontask.git
   cd distributed-cron
   ```

2. **Настройка переменных окружения**:

   Скопируйте файл `.env.example` в `.env` и настройте параметры подключения к базе данных MySQL:

   ```bash
   cp .env.example .env
   ```

   Измените значения под ваши настройки.

3. **Установка зависимостей**:

   Убедитесь, что у вас установлен Composer. Выполните команду установки зависимостей:

   ```bash
   composer install
   ```

4. **Создание и миграция базы данных**:

   Запустите миграции для создания необходимых таблиц:

   ```bash
   php artisan migrate
   ```

5. **Запуск Docker-контейнера**:

   Если вы используете Docker, выполните:

   ```bash
   sudo docker-compose up --build
   ```

6. **Проверка работы**:

   Убедитесь, что приложение запущено и работает. Вы можете проверить логи:

   ```bash
   sudo docker logs app-cron-task
   ```

Теперь вы готовы использовать Distributed Cron Task Manager для управления Cron-задачами.
```
